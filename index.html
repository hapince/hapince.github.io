<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>斗地主</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/telegram-web-app/6.7.0/telegram-web-app.min.js"></script>
    <style>
        /* 强制横屏 */
        @media screen and (orientation: portrait) {
            html {
                transform: rotate(-90deg);
                transform-origin: left top;
                width: 100vh;
                height: 100vw;
                position: absolute;
                top: 100%;
                left: 0;
            }
            body {
                width: 100vh;
                height: 100vw;
            }
        }

        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        body {
            background-color: #076324;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: fixed;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 2px;
            box-sizing: border-box;
        }

        /* 地主牌区域 */
        #landlord-area {
            height: 10vh;
            display: flex;
            justify-content: center;
            gap: 2px;
            padding: 2px;
        }

        /* 玩家区域 */
        #players-area {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            position: relative;
        }

        .player-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1vh;
            width: 20vw;
            height: 100%;
        }

        /* 出牌区域样式 - 修改为重叠效果 */
        #left-played-cards,
        #right-played-cards,
        #played-cards {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 10vh;
            width: 100%;
            gap: 1px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            padding: 2px;
            position: relative;
        }

        /* 重叠卡牌样式 */
        #left-played-cards .card,
        #right-played-cards .card,
        #played-cards .card {
            position: absolute;
            width: 4.5vh;
            height: 6.5vh;
            font-size: 1.2vh;
            margin-left: -2vh; /* 负边距创造重叠效果 */
        }

        /* 手牌区域 */
        #hand-area {
            height: 15vh;
            display: flex;
            justify-content: center;
            gap: 1px;
            padding: 2px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #hand-area::-webkit-scrollbar {
            display: none;
        }

        /* 基础卡牌样式 */
        .card {
            width: 5.5vh;
            height: 8vh;
            background: white;
            border-radius: 3px;
            border: 1px solid #000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1px;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: transform 0.2s;
            font-size: 1.4vh;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        .card.selected {
            transform: translateY(-1.5vh);
        }

        .card-red {
            color: red;
        }

        .card-black {
            color: black;
        }

        /* 控制按钮 */
        #controls {
            height: 8vh;
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 2px;
            margin-bottom: env(safe-area-inset-bottom, 0px);
        }

        .button {
            padding: 0.8vh 1.6vh;
            border: none;
            border-radius: 3px;
            background: #4CAF50;
            color: white;
            font-size: 1.4vh;
            cursor: pointer;
            min-width: 12vw;
            touch-action: manipulation;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* 状态样式 */
        .player-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5vh;
            border-radius: 3px;
            text-align: center;
            font-size: 1.4vh;
        }

        .active-player {
            box-shadow: 0 0 10px #FFD700;
        }

        .timer {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 3vh;
            height: 3vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4vh;
            margin-top: 0.5vh;
        }

        #play-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 40%;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="landlord-area"></div>
        <div id="players-area">
            <div class="player-section">
                <div class="player-status" id="left-player">
                    左边玩家<br>17张
                </div>
                <div class="player-cards" id="left-played-cards"></div>
                <div class="timer" id="left-timer">15</div>
            </div>
            <div id="play-area">
                <div id="played-cards"></div>
            </div>
            <div class="player-section">
                <div class="player-status" id="right-player">
                    右边玩家<br>17张
                </div>
                <div class="player-cards" id="right-played-cards"></div>
                <div class="timer" id="right-timer">15</div>
            </div>
        </div>
        <div id="hand-area"></div>
        <div class="timer" id="player-timer">15</div>
        <div id="controls">
            <button class="button" id="start-button">开始游戏</button>
            <button class="button" id="play-button" disabled>出牌</button>
            <button class="button" id="pass-button" disabled>不出</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp || {
            expand: () => {},
            showAlert: (text) => alert(text)
        };

        try {
            tg.expand();
        } catch (e) {
            console.log('Running outside of Telegram WebApp');
        }

        class Card {
            constructor(suit, value, display) {
                this.suit = suit;
                this.value = value;
                this.display = display;
                this.isRed = suit === '♥' || suit === '♦';
            }

            toString() {
                return this.suit + this.display;
            }
        }

        class Game {
            constructor() {
                this.initGame();
                this.setupEventListeners();
            }

            initGame() {
                this.allCards = this.createDeck();
                this.playerHands = [[], [], []];
                this.landlordCards = [];
                this.selectedCards = new Set();
                this.playedCards = [[], [], []];  // 每个玩家的出牌记录
                this.currentPlayer = 0;
                this.isGameStarted = false;
                this.lastPlayedBy = -1;
                this.consecutivePasses = 0;
                this.timers = [null, null, null];
                this.timeLeft = [15, 15, 15];
            }

            startTimer(playerIndex) {
                this.clearAllTimers();
                this.timeLeft[playerIndex] = 15;
                
                const timerElement = document.getElementById(
                    playerIndex === 0 ? 'player-timer' :
                    playerIndex === 1 ? 'left-timer' : 'right-timer'
                );
                
                this.timers[playerIndex] = setInterval(() => {
                    this.timeLeft[playerIndex]--;
                    if (timerElement) {
                        timerElement.textContent = this.timeLeft[playerIndex];
                    }
                    
                    if (this.timeLeft[playerIndex] <= 0) {
                        this.clearAllTimers();
                        if (playerIndex === 0) {
                            this.passTurn();
                        } else {
                            this.simulateAIPlay(true);  // 强制AI出牌
                        }
                    }
                }, 1000);
            }

            clearAllTimers() {
                this.timers.forEach((timer, index) => {
                    if (timer) {
                        clearInterval(timer);
                        this.timers[index] = null;
                    }
                });
            }

            createDeck() {
                const suits = ['♠', '♥', '♣', '♦'];
                const values = [
                    {value: 3, display: '3'},
                    {value: 4, display: '4'},
                    {value: 5, display: '5'},
                    {value: 6, display: '6'},
                    {value: 7, display: '7'},
                    {value: 8, display: '8'},
                    {value: 9, display: '9'},
                    {value: 10, display: '10'},
                    {value: 11, display: 'J'},
                    {value: 12, display: 'Q'},
                    {value: 13, display: 'K'},
                    {value: 14, display: 'A'},
                    {value: 15, display: '2'},
                ];

                let deck = [];
                for (let suit of suits) {
                    for (let {value, display} of values) {
                        deck.push(new Card(suit, value, display));
                    }
                }
                deck.push(new Card('', 16, '小王'));
                deck.push(new Card('', 17, '大王'));
                return deck;
            }

            shuffleCards() {
                for (let i = this.allCards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.allCards[i], this.allCards[j]] = [this.allCards[j], this.allCards[i]];
                }
            }

            dealCards() {
                this.playerHands[0] = this.allCards.slice(0, 17);
                this.playerHands[1] = this.allCards.slice(17, 34);
                this.playerHands[2] = this.allCards.slice(34, 51);
                this.landlordCards = this.allCards.slice(51);

                this.sortHands();
            }

            sortHands() {
                for (let hand of this.playerHands) {
                    hand.sort((a, b) => b.value - a.value);
                }
            }

            createCardElement(card, selectable = false) {
                const cardDiv = document.createElement('div');
                cardDiv.className = `card ${card.isRed ? 'card-red' : 'card-black'}`;
                cardDiv.textContent = card.toString();
                
                if (selectable) {
                    cardDiv.onclick = () => this.toggleCardSelection(card, cardDiv);
                }

                return cardDiv;
            }

            toggleCardSelection(card, element) {
                if (!this.isGameStarted || this.currentPlayer !== 0) return;

                if (this.selectedCards.has(card)) {
                    this.selectedCards.delete(card);
                    element.classList.remove('selected');
                } else {
                    this.selectedCards.add(card);
                    element.classList.add('selected');
                }
            }

            updateDisplay() {
                updateDisplay() {
                    // 显示地主牌
                    const landlordArea = document.getElementById('landlord-area');
                    landlordArea.innerHTML = '';
                    if (this.isGameStarted) {
                        this.landlordCards.forEach(card => {
                            landlordArea.appendChild(this.createCardElement(card));
                        });
                    }

                    // 更新玩家手牌
                    const handArea = document.getElementById('hand-area');
                    handArea.innerHTML = '';
                    this.playerHands[0].forEach(card => {
                        handArea.appendChild(this.createCardElement(card, true));
                    });

                    // 更新其他玩家状态和出牌
                    document.getElementById('left-player').innerHTML = 
                        `左边玩家<br>${this.playerHands[1].length}张`;
                    document.getElementById('right-player').innerHTML = 
                        `右边玩家<br>${this.playerHands[2].length}张`;

                    // 定义更新出牌区域的辅助函数，添加重叠效果
                    const updatePlayedCards = (container, cards) => {
                        container.innerHTML = '';
                        cards.forEach((card, index) => {
                            const cardElement = this.createCardElement(card);
                            cardElement.style.transform = `translateX(${index * 2}vh)`; // 每张牌向右偏移
                            container.appendChild(cardElement);
                        });
                    };

                    // 更新各玩家出牌区域
                    updatePlayedCards(document.getElementById('left-played-cards'), this.playedCards[1]);
                    updatePlayedCards(document.getElementById('right-played-cards'), this.playedCards[2]);
                    updatePlayedCards(document.getElementById('played-cards'), this.playedCards[0]);

                    // 更新按钮状态
                    document.getElementById('play-button').disabled = !this.isGameStarted || this.currentPlayer !== 0;
                    document.getElementById('pass-button').disabled = !this.isGameStarted || this.currentPlayer !== 0 || this.lastPlayedBy === -1;

                    // 高亮当前玩家
                    ['left-player', 'right-player'].forEach((id, index) => {
                        const element = document.getElementById(id);
                        if (this.currentPlayer === index + 1) {
                            element.classList.add('active-player');
                        } else {
                            element.classList.remove('active-player');
                        }
                    });
                }
            }

            setupEventListeners() {
                document.getElementById('start-button').onclick = () => this.startGame();
                document.getElementById('play-button').onclick = () => this.playCards();
                document.getElementById('pass-button').onclick = () => this.passTurn();
            }

            startGame() {
                this.isGameStarted = true;
                this.shuffleCards();
                this.dealCards();
                this.updateDisplay();
                this.startTimer(0);

                document.getElementById('start-button').disabled = true;
                document.getElementById('play-button').disabled = false;
                document.getElementById('pass-button').disabled = true;

                tg.showAlert('游戏开始！');
            }

            simulateAIPlay(forcePlay = false) {
                setTimeout(() => {
                    if (this.currentPlayer !== 0) {
                        const aiHand = this.playerHands[this.currentPlayer];
                        if (aiHand.length > 0) {
                            if (forcePlay || Math.random() > 0.3) {  // 70% 概率出牌
                                const cardToPlay = [aiHand[aiHand.length - 1]];
                                this.playedCards[this.currentPlayer] = cardToPlay;  // 更新对应玩家的出牌记录
                                aiHand.pop();
                                this.lastPlayedBy = this.currentPlayer;
                                this.consecutivePasses = 0;

                                if (aiHand.length === 0) {
                                    this.clearAllTimers();
                                    tg.showAlert('电脑赢了！');
                                    this.resetGame();
                                    return;
                                }
                            } else {
                                this.playedCards[this.currentPlayer] = [];  // 清空当前AI玩家的出牌
                                this.consecutivePasses++;
                            }
                        }

                        if (this.consecutivePasses >= 2) {
                            this.playedCards = [[], [], []];  // 清空所有玩家的出牌
                            this.lastPlayedBy = -1;
                            this.consecutivePasses = 0;
                        }

                        this.currentPlayer = (this.currentPlayer + 1) % 3;
                        this.updateDisplay();
                        
                        if (this.currentPlayer === 0) {
                            this.startTimer(0);
                        } else {
                            this.startTimer(this.currentPlayer);
                            this.simulateAIPlay();
                        }
                    }
                }, 1000);
            }

            playCards() {
                if (this.selectedCards.size === 0) {
                    tg.showAlert('请选择要出的牌');
                    return;
                }

                const cardsToPlay = Array.from(this.selectedCards);
                for (let card of cardsToPlay) {
                    const index = this.playerHands[0].indexOf(card);
                    if (index !== -1) {
                        this.playerHands[0].splice(index, 1);
                    }
                }

                this.playedCards[0] = cardsToPlay;  // 更新玩家的出牌记录
                this.selectedCards.clear();
                this.lastPlayedBy = 0;
                this.consecutivePasses = 0;

                if (this.playerHands[0].length === 0) {
                    this.clearAllTimers();
                    tg.showAlert('恭喜你赢了！');
                    this.resetGame();
                    return;
                }

                this.currentPlayer = (this.currentPlayer + 1) % 3;
                this.updateDisplay();

                if (this.currentPlayer !== 0) {
                    this.startTimer(this.currentPlayer);
                    this.simulateAIPlay();
                }
            }

            passTurn() {
                this.selectedCards.clear();
                this.playedCards[0] = [];  // 清空玩家的出牌
                this.consecutivePasses++;

                if (this.consecutivePasses >= 2) {
                    this.playedCards = [[], [], []];  // 清空所有玩家的出牌
                    this.lastPlayedBy = -1;
                    this.consecutivePasses = 0;
                }

                this.currentPlayer = (this.currentPlayer + 1) % 3;
                this.updateDisplay();

                if (this.currentPlayer !== 0) {
                    this.startTimer(this.currentPlayer);
                    this.simulateAIPlay();
                }
            }

            resetGame() {
                this.clearAllTimers();
                this.initGame();
                this.updateDisplay();
                document.getElementById('start-button').disabled = false;
                document.getElementById('play-button').disabled = true;
                document.getElementById('pass-button').disabled = true;
            }
        }

        const game = new Game();
    </script>
</body>
</html>